{% extends "main/base.html" %}
{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'home' %}" class="text-decoration-none"><i class="bi bi-house-door me-1"></i>Home</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Course: <span id="course-title">Loading...</span></li>
                </ol>
            </nav>
            
            <div id="loading" class="text-center my-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Creating your course... this may take a few minutes</p>
            </div>
            
            <div class="course-container d-none">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <h2 class="mb-0 fw-bold" id="course-title-header">Loading Course...</h2>
                    <span class="badge bg-primary rounded-pill"><i class="bi bi-play-fill"></i> <span id="lesson-count">0</span> Lessons</span>
                </div>
            </div>
            
            <div class="row g-4" id="output"></div>
        </div>
    </div>
</div>

<style>
.card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: none;
    border-radius: 12px;
    overflow: hidden;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
}

.card-img-top {
    height: 180px;
    object-fit: cover;
}

.card-body {
    padding: 1.25rem;
}

.card-title {
    font-size: 1rem;
    font-weight: 500;
    line-height: 1.4;
    height: 2.8rem;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.btn-primary {
    background-color: #3d7cf4;
    border-color: #3d7cf4;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    text-transform: uppercase;
    font-size: 0.8rem;
    font-weight: 500;
    letter-spacing: 0.5px;
    transition: all 0.2s ease;
}

.btn-primary:hover {
    background-color: #2c6bdf;
    border-color: #2c6bdf;
    box-shadow: 0 4px 8px rgba(44, 107, 223, 0.2);
}

.badge {
    padding: 0.5rem 1rem;
    font-weight: 500;
}

.breadcrumb-item a {
    color: #3d7cf4;
}
</style>

<script>
const playlistId = "{{ playlist_id }}";
let socket;
let lessonCount = 0;

// Initialize WebSocket connection
function connectWebSocket() {
    // Close existing socket if it exists
    if (socket && socket.readyState !== WebSocket.CLOSED) {
        socket.close();
    }
    
    socket = new WebSocket('ws://' + window.location.host + '/ws/playlist/');
    
    socket.onopen = function() {
        // Send the playlist ID to start or continue processing
        socket.send(JSON.stringify({ playlist_id: playlistId }));
    };
    
    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        if (data.type === "video") {
            // Add the video to the UI
            renderVideo(data);
            
            // Increment lesson count
            lessonCount++;
            document.getElementById("lesson-count").textContent = lessonCount;
            
            // Hide loading spinner once we start seeing videos
            document.getElementById("loading").style.display = "none";
            document.querySelector('.course-container').classList.remove('d-none');
        } 
        else if (data.type === "playlist_info") {
            // Update the course title in multiple places
            const title = data.title || "New Course";
            document.getElementById("course-title").textContent = title;
            document.getElementById("course-title-header").textContent = title;
            document.title = `${title} - Make Courses`;
        }
        else if (data.type === "processing_complete") {
            // Hide loading indicator when processing is complete
            document.getElementById("loading").style.display = "none";
            document.querySelector('.course-container').classList.remove('d-none');
            
            // Close the WebSocket connection since we don't need it anymore
            if (socket && socket.readyState !== WebSocket.CLOSED) {
                socket.close();
            }
            
            // If no videos were loaded, show a message
            const output = document.getElementById("output");
            if (output.children.length === 0) {
                output.innerHTML = `
                    <div class="col-12 text-center">
                        <div class="alert alert-info">
                            <i class="bi bi-exclamation-circle me-2"></i>
                            No lessons found in this course. The playlist might be empty or private.
                        </div>
                    </div>
                `;
            }
        }
        else if (data.type === "error") {
            // Display error message
            document.getElementById("loading").innerHTML = 
                `<div class="alert alert-danger">${data.message}</div>`;
        }
    };
    
    socket.onerror = function(error) {
        console.error("WebSocket error:", error);
        document.getElementById("loading").innerHTML = 
            `<div class="alert alert-danger">Connection error. Please try refreshing the page.</div>`;
    };
    
    socket.onclose = function() {
        console.log("WebSocket connection closed");
    };
}

// Function to render a video card
function renderVideo(data) {
    const output = document.getElementById("output");
    const videoElement = document.createElement("div");
    videoElement.className = "col-md-6 col-lg-4";
    videoElement.innerHTML = `
        <div class="card h-100 shadow-sm">
            <div class="position-relative">
                <img src="${data.thumbnail}" class="card-img-top" alt="${data.title}">
                <div class="position-absolute bottom-0 end-0 p-2">
                    <span class="badge bg-dark">Lesson ${lessonCount + 1}</span>
                </div>
            </div>
            <div class="card-body d-flex flex-column">
                <h5 class="card-title mb-3">${data.title}</h5>
                <a href="/video/${data.id}/" class="btn btn-primary mt-auto">
                    <i class="bi bi-book me-1"></i> View Lesson
                </a>
            </div>
        </div>
    `;
    output.appendChild(videoElement);
}

// Connect when page loads
connectWebSocket();

// Ensure socket is closed when navigating away
window.addEventListener('beforeunload', function() {
    if (socket && socket.readyState !== WebSocket.CLOSED) {
        socket.close();
    }
});
</script>
{% endblock %}
